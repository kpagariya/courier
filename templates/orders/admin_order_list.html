{% extends 'base.html' %}

{% block title %}Manage Orders - Admin - Helpii{% endblock %}

{% block extra_css %}
<style>
    /* Larger admin table styling */
    .table-sm td, .table-sm th {
        padding: 0.55rem 0.45rem;
        font-size: 0.95rem;  /* Increased for better readability */
        vertical-align: middle;
    }
    
    .table-sm th {
        font-size: 0.92rem;
        font-weight: 600;
        letter-spacing: 0.3px;
        text-align: center;
        vertical-align: middle;
    }
    
    .status-badge {
        font-size: 0.85rem;
        padding: 0.3rem 0.55rem;
    }
    
    /* Minimal spacing */
    section {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }
    
    .card {
        margin-bottom: 0 !important;
    }
    
    /* Inline stat cards */
    .bg-dark .card {
        border: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: transform 0.2s;
    }
    
    .bg-dark .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    /* Compact buttons */
    .btn-group-sm .btn {
        padding: 0.25rem 0.6rem;
        font-weight: 500;
    }
    
    /* Route column - clean addresses without KM */
    .table td:nth-child(3) {
        font-size: 0.9rem;
        line-height: 1.6;
    }
    
    /* KM column - centered, bold, distinct */
    .table td:nth-child(4) {
        text-align: center;
        font-weight: 700;
        font-size: 1rem;
        color: #2563eb;
    }
    
    /* Weight column - centered without "kg" */
    .table td:nth-child(5) {
        text-align: center;
        font-weight: 700;
        font-size: 1rem;
    }
    
    /* Better row spacing for full addresses */
    .table tbody tr {
        height: auto;
        min-height: 75px;
    }
    
    /* Order ID column - larger font */
    .table td:nth-child(1) {
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Admin Header with centered stats -->
<div class="bg-dark text-white py-2" style="position: relative; z-index: 100;">
    <div class="container-fluid px-3">
        <!-- Row 1: Title and Filter Buttons (Centered) -->
        <div class="d-flex flex-wrap justify-content-center align-items-center gap-3 mb-2">
            <h6 class="mb-0"><i class="bi bi-list-check me-1"></i>Manage Orders</h6>
            <div class="btn-group btn-group-sm" role="group">
                <a href="{% url 'orders:admin_order_list' %}" class="btn btn-sm {% if not status_filter %}btn-light{% else %}btn-outline-light{% endif %}" style="font-size: 0.8rem;">
                    All Orders
                </a>
                <a href="?status=UNDER_REVIEW" class="btn btn-sm {% if status_filter == 'UNDER_REVIEW' %}btn-warning text-dark{% else %}btn-outline-light{% endif %}" style="font-size: 0.8rem;">
                    Pending Review
                </a>
                <a href="{% url 'admin:index' %}" class="btn btn-sm btn-outline-light" style="font-size: 0.8rem;">
                    Admin Panel
                </a>
            </div>
        </div>
        
        <!-- Row 2: This Month's Statistics (Centered) -->
        <div class="d-flex flex-wrap justify-content-center align-items-center gap-2">
            <small class="text-white-50 me-2"><i class="bi bi-calendar-month me-1"></i>This Month:</small>
            <span class="badge bg-primary px-3 py-2">
                <span class="fw-bold">{{ stats.total_orders }}</span> Orders
            </span>
            <span class="badge bg-warning text-dark px-3 py-2">
                <span class="fw-bold">{{ stats.pending }}</span> Pending
            </span>
            <span class="badge bg-success px-3 py-2">
                <span class="fw-bold">{{ stats.delivered }}</span> Delivered
            </span>
            <span class="badge bg-info px-3 py-2">
                <span class="fw-bold">${{ stats.revenue|floatformat:0 }}</span> Revenue
            </span>
        </div>
    </div>
        </div>
    </div>
</div>

<section class="py-2">
    <div class="container-fluid px-3">
        <!-- Ultra Compact Search Bar -->
        <div class="row mb-2 align-items-center">
            <div class="col-md-3">
                <form method="get" class="d-flex gap-1">
                    <input type="text" name="search" class="form-control form-control-sm" placeholder="Search..." value="{{ search_query|default:'' }}" style="font-size: 0.8rem;">
                    <button type="submit" class="btn btn-sm btn-primary" style="font-size: 0.75rem;">
                        <i class="bi bi-search"></i>
                    </button>
                </form>
            </div>
            <div class="col-md-9 text-end">
                <div class="btn-group btn-group-sm" role="group">
                    <a href="?status=ACCEPTED" class="btn btn-outline-secondary {% if status_filter == 'ACCEPTED' %}active{% endif %}" style="font-size: 0.75rem;">Accepted</a>
                    <a href="?status=PICKED" class="btn btn-outline-secondary {% if status_filter == 'PICKED' %}active{% endif %}" style="font-size: 0.75rem;">Picked</a>
                    <a href="?status=ON_THE_WAY" class="btn btn-outline-secondary {% if status_filter == 'ON_THE_WAY' %}active{% endif %}" style="font-size: 0.75rem;">On Way</a>
                    <a href="?status=DELIVERED" class="btn btn-outline-secondary {% if status_filter == 'DELIVERED' %}active{% endif %}" style="font-size: 0.75rem;">Delivered</a>
                </div>
            </div>
        </div>
        
        <!-- Orders Table (Compact) -->
        <div class="card shadow-sm">
            <div class="card-body p-0">
                {% if orders %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-dark">
                                <tr class="text-center">
                                    <th style="width: 10%;">Order ID</th>
                                    <th style="width: 12%;">Customer</th>
                                    <th style="width: 32%;">Route</th>
                                    <th style="width: 6%;">KM</th>
                                    <th style="width: 4%;">Weight</th>
                                    <th style="width: 10%;">Status</th>
                                    <th style="width: 8%;">Amount</th>
                                    <th style="width: 4%;">Paid</th>
                                    <th style="width: 8%;">Date</th>
                                    <th style="width: 6%;">Action</th>
                                </tr>
                            </thead>
                            <tbody class="align-middle">
                                {% for order in orders %}
                                <tr {% if order.customer_proposed_price and not order.courier_amount %}class="table-warning"{% endif %}>
                                    <td>
                                        <div class="text-primary fw-bold" style="font-size: 0.9rem;">
                                            {{ order.order_id }}
                                            {% if order.customer_proposed_price and not order.courier_amount %}
                                            <span class="badge bg-warning text-dark" title="Negotiation">ðŸ’°</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="fw-semibold" style="font-size: 0.92rem;">{{ order.customer.get_full_name }}</div>
                                        <small class="text-muted" style="font-size: 0.82rem;">{{ order.customer.contact }}</small>
                                    </td>
                                    <td>
                                        <div style="line-height: 1.5;">
                                            <div class="mb-1">
                                                <i class="bi bi-geo-alt-fill text-success me-1"></i>
                                                <span style="font-size: 0.9rem;">{{ order.pickup_address|truncatewords:8 }}</span>
                                            </div>
                                            <div>
                                                <i class="bi bi-geo-fill text-danger me-1"></i>
                                                <span style="font-size: 0.9rem;">{{ order.delivery_address|truncatewords:8 }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% if order.distance_km %}
                                            <span class="fw-bold text-primary" style="font-size: 1rem;">{{ order.distance_km }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="fw-bold" style="font-size: 1rem;">{{ order.parcel_weight }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ order.get_status_display_class }}" style="font-size: 0.88rem; padding: 0.4rem 0.65rem;">
                                            {{ order.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if order.courier_amount %}
                                            <strong class="text-primary" style="font-size: 0.95rem;">${{ order.courier_amount }}</strong>
                                        {% elif order.customer_proposed_price %}
                                            <div class="text-success" style="font-size: 0.78rem;">Est: ${{ order.auto_calculated_amount|default:"-" }}</div>
                                            <div class="text-warning fw-bold" style="font-size: 0.88rem;">ðŸ’° ${{ order.customer_proposed_price }}</div>
                                        {% elif order.auto_calculated_amount %}
                                            <span class="text-success" style="font-size: 0.88rem;">Est: ${{ order.auto_calculated_amount }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if order.is_paid %}
                                            <i class="bi bi-check-circle-fill text-success" style="font-size: 1.4rem;"></i>
                                        {% else %}
                                            <i class="bi bi-x-circle text-muted" style="font-size: 1.2rem;"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="fw-semibold" style="font-size: 0.95rem;">{{ order.created_at|date:"M d" }}</span>
                                    </td>
                                    <td>
                                        <a href="{% url 'orders:admin_order_detail' order.order_id %}" class="btn btn-sm btn-primary" style="font-size: 0.82rem;">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                        <h5 class="mt-3">No orders found</h5>
                        <p class="text-muted">Try adjusting your filters</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}


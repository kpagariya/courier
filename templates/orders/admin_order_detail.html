{% extends 'base.html' %}

{% block title %}Manage Order #{{ order.order_id }} - Admin - Helpii{% endblock %}

{% block content %}
<div class="bg-dark text-white py-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold">Manage Order #{{ order.order_id }}</h2>
                <p class="mb-0">Review and update order details</p>
            </div>
            <span class="status-badge bg-{{ order.get_status_display_class }}">
                {{ order.get_status_display }}
            </span>
        </div>
    </div>
</div>

<section class="py-5">
    <div class="container">
        <div class="row g-4">
            <!-- Order Management -->
            <div class="col-lg-8">
                <!-- Customer Information -->
                <div class="card mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-person me-2"></i>Customer Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <strong>Name:</strong> {{ order.customer.get_full_name }}
                            </div>
                            <div class="col-md-6 mb-2">
                                <strong>Email:</strong> {{ order.customer.email }}
                            </div>
                            <div class="col-md-6 mb-2">
                                <strong>Contact:</strong> {{ order.customer.contact }}
                            </div>
                            <div class="col-md-6 mb-2">
                                <strong>Member Since:</strong> {{ order.customer.date_joined|date:"M Y" }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Addresses -->
                <div class="card mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Addresses</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-2">Pickup Address</h6>
                                <p>{{ order.pickup_address }}</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-2">Delivery Address</h6>
                                <p>{{ order.delivery_address }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Parcel Details -->
                <div class="card mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-box me-2"></i>Parcel Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <strong>Weight:</strong> {{ order.parcel_weight }} kg
                            </div>
                            <div class="col-md-4 mb-3">
                                <strong>Quantity:</strong> {{ order.quantity }} parcel(s)
                            </div>
                            <div class="col-md-4 mb-3">
                                <strong>Dimensions:</strong> {{ order.get_dimensions_display }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Parcel Type:</strong> {{ order.get_parcel_type_display }}
                            </div>
                            {% if order.distance_km %}
                            <div class="col-md-6 mb-3">
                                <strong>Distance:</strong> {{ order.distance_km }} km
                            </div>
                            {% endif %}
                            {% if order.auto_calculated_amount %}
                            <div class="col-md-6 mb-3">
                                <strong>System Estimated Price:</strong> 
                                <span class="text-success fw-bold">NZD ${{ order.auto_calculated_amount }}</span>
                            </div>
                            {% endif %}
                            
                            {% comment %} Only show if customer actually proposed a price {% endcomment %}
                            {% if order.customer_proposed_price %}
                            <div class="col-md-6 mb-3">
                                <strong>Customer's Counter-Offer:</strong> 
                                <span class="text-warning fw-bold">NZD ${{ order.customer_proposed_price }}</span>
                                <br><small class="text-muted">Customer's preferred price</small>
                            </div>
                            {% endif %}
                            {% if order.description %}
                            <div class="col-12 mb-3">
                                <strong>Description:</strong><br>{{ order.description }}
                            </div>
                            {% endif %}
                            {% if order.parcel_image %}
                            <div class="col-12">
                                <strong>Parcel Image:</strong><br>
                                <img src="{{ order.parcel_image.url }}" alt="Parcel" class="img-fluid rounded mt-2" style="max-height: 300px;">
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Sidebar -->
            <div class="col-lg-4">
                <!-- Pricing Information -->
                {% if order.auto_calculated_amount or order.customer_proposed_price %}
                <div class="card mb-3 border-primary">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-cash-coin me-2"></i>Pricing Information</h6>
                    </div>
                    <div class="card-body">
                        {% if order.auto_calculated_amount %}
                        <div class="mb-2">
                            <small class="text-muted">System Estimate:</small>
                            <p class="mb-0 h5 text-success">NZD ${{ order.auto_calculated_amount }}</p>
                        </div>
                        {% endif %}
                        
                        {% comment %} Only show customer negotiation if it was enabled when order was created {% endcomment %}
                        {% if order.customer_proposed_price %}
                        <div class="mb-2 pt-2 border-top">
                            <small class="text-muted">Customer's Offer:</small>
                            <p class="mb-0 h5 text-warning">NZD ${{ order.customer_proposed_price }}</p>
                        </div>
                        
                        {% if order.auto_calculated_amount %}
                        <div class="alert alert-info p-2 mb-0 mt-2">
                            <small><strong>ðŸ’¡ Decision:</strong> Customer wants lower price. Review and set final amount below.</small>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Quick Actions -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        {% if order.status == 'UNDER_REVIEW' %}
                            <form method="post" class="mb-3">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="accept">
                                <label class="form-label fw-bold">Final Courier Amount (NZD)</label>
                                {% if order.auto_calculated_amount %}
                                <input type="number" name="courier_amount" class="form-control mb-2" step="0.01" required placeholder="Enter amount" value="{{ order.auto_calculated_amount }}">
                                <small class="text-muted d-block mb-2">
                                    {% if order.customer_proposed_price %}
                                    System: ${{ order.auto_calculated_amount }} | Customer: ${{ order.customer_proposed_price }}
                                    {% else %}
                                    System estimated: ${{ order.auto_calculated_amount }}
                                    {% endif %}
                                </small>
                                {% else %}
                                <input type="number" name="courier_amount" class="form-control mb-2" step="0.01" required placeholder="Enter amount">
                                {% endif %}
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="bi bi-check-circle me-2"></i>Accept Order
                                </button>
                            </form>
                            
                            <form method="post">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="reject">
                                <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Are you sure you want to reject this order?')">
                                    <i class="bi bi-x-circle me-2"></i>Reject Order
                                </button>
                            </form>
                        {% else %}
                            <form method="post" class="mb-3">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="update_status">
                                <label class="form-label fw-bold">Update Status</label>
                                <select name="status" class="form-select mb-2" required>
                                    <option value="">Select Status...</option>
                                    <option value="ACCEPTED" {% if order.status == 'ACCEPTED' %}selected{% endif %}>Accepted</option>
                                    <option value="PICKED" {% if order.status == 'PICKED' %}selected{% endif %}>Picked</option>
                                    <option value="ON_THE_WAY" {% if order.status == 'ON_THE_WAY' %}selected{% endif %}>On the Way</option>
                                    <option value="DELIVERED" {% if order.status == 'DELIVERED' %}selected{% endif %}>Delivered</option>
                                </select>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-arrow-repeat me-2"></i>Update Status
                                </button>
                            </form>
                            
                            <hr>
                            
                            <form method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="upload_delivery_proof">
                                <label class="form-label fw-bold">Delivery Proof Image</label>
                                {% if order.delivery_proof_image %}
                                <div class="mb-2">
                                    <img src="{{ order.delivery_proof_image.url }}" alt="Current" class="img-fluid rounded" style="max-height: 150px;">
                                    <p class="text-success small mb-0 mt-1"><i class="bi bi-check-circle me-1"></i>Already uploaded</p>
                                </div>
                                {% endif %}
                                <input type="file" name="delivery_proof_image" class="form-control mb-2" accept="image/*" required>
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="bi bi-camera me-2"></i>Upload Delivery Proof
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Order Information -->
                <div class="card mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Order Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted">Order ID</small>
                            <p class="mb-0 fw-bold">{{ order.order_id }}</p>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Created</small>
                            <p class="mb-0">{{ order.created_at|date:"M d, Y h:i A" }}</p>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Last Updated</small>
                            <p class="mb-0">{{ order.updated_at|date:"M d, Y h:i A" }}</p>
                        </div>
                        {% if order.courier_amount %}
                        <div class="mb-3">
                            <small class="text-muted">Courier Amount</small>
                            <p class="mb-0 h5 text-primary">NZD ${{ order.courier_amount }}</p>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Payment Status</small>
                            <p class="mb-0">
                                {% if order.is_paid %}
                                    <span class="badge bg-success">Paid</span>
                                {% else %}
                                    <span class="badge bg-warning">Pending</span>
                                {% endif %}
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Timeline</h5>
                    </div>
                    <div class="card-body">
                        <div class="timeline-sm">
                            <div class="timeline-item-sm">
                                <strong>Created</strong><br>
                                <small class="text-muted">{{ order.created_at|date:"M d, h:i A" }}</small>
                            </div>
                            {% if order.accepted_at %}
                            <div class="timeline-item-sm">
                                <strong>Accepted</strong><br>
                                <small class="text-muted">{{ order.accepted_at|date:"M d, h:i A" }}</small>
                            </div>
                            {% endif %}
                            {% if order.picked_at %}
                            <div class="timeline-item-sm">
                                <strong>Picked</strong><br>
                                <small class="text-muted">{{ order.picked_at|date:"M d, h:i A" }}</small>
                            </div>
                            {% endif %}
                            {% if order.delivered_at %}
                            <div class="timeline-item-sm">
                                <strong>Delivered</strong><br>
                                <small class="text-muted">{{ order.delivered_at|date:"M d, h:i A" }}</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <a href="{% url 'orders:admin_order_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to Orders
            </a>
            <a href="{% url 'admin:orders_order_change' order.id %}" class="btn btn-outline-primary ms-2">
                <i class="bi bi-gear me-2"></i>Advanced Edit
            </a>
        </div>
    </div>
</section>

<style>
.timeline-sm {
    border-left: 2px solid #dee2e6;
    padding-left: 15px;
}

.timeline-item-sm {
    position: relative;
    margin-bottom: 20px;
}

.timeline-item-sm::before {
    content: '';
    position: absolute;
    left: -20px;
    top: 5px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: var(--primary-color);
    border: 2px solid white;
}
</style>
{% endblock %}

